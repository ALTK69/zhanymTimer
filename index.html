<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2299.77">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000; min-height: 16.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!doctype html&gt;</span></p>
<p class="p1"><span class="s1">&lt;html lang="ru"&gt;</span></p>
<p class="p1"><span class="s1">&lt;head&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta charset="utf-8" /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;title&gt;Pomodoro Sync&lt;/title&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>/* --- Минималистичный адаптивный дизайн --- */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>:root{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--bg: #f7fafc; /* very light */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--card: #ffffff;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--accent: #a3d9c9; /* pastel */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--accent-2: #f6c7c7;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--muted: #6b7280;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--shadow: 0 6px 18px rgba(15,23,42,0.06);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>--glass: rgba(255,255,255,0.6);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>*{box-sizing:border-box}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>body{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>margin:0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>background: linear-gradient(180deg, var(--bg), #ffffff);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>display:flex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>align-items:center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>justify-content:center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>min-height:100vh;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>padding:20px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>color:#111827;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.container{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width:100%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>max-width:980px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>display:grid;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>grid-template-columns: 1fr 360px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>gap:24px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>@media (max-width:880px){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.container{grid-template-columns:1fr;}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.card{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>background:var(--card);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>border-radius:16px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>padding:20px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>box-shadow:var(--shadow);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>/* Left: timer */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.timer-wrap{display:flex;flex-direction:column;align-items:center;gap:18px;padding:36px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.circle{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width:280px;height:280px;border-radius:50%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>display:flex;align-items:center;justify-content:center;position:relative;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>background: conic-gradient(var(--accent) 0deg, rgba(0,0,0,0.04) 0deg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>transition: background 0.3s ease;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>box-shadow: 0 8px 30px rgba(99,102,241,0.05) inset;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>@media (max-width:520px){ .circle{width:220px;height:220px}}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.circle .center{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width:78%;height:78%;background:var(--card);border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>box-shadow: 0 6px 18px rgba(15,23,42,0.06);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.time{font-size:44px;font-weight:600}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.mode{font-size:14px;color:var(--muted);margin-top:6px}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.controls{display:flex;gap:12px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.btn{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>border:0;padding:10px 16px;border-radius:10px;background:var(--accent);cursor:pointer;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,0.06);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.btn.secondary{background:var(--card);border:1px solid #e6e9ef}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.btn.warn{background:var(--accent-2)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>/* Right column: settings + users */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>label{font-size:13px;color:var(--muted)}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>input[type="number"], input[type="text"], select{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>padding:8px;border-radius:8px;border:1px solid #eef2f7;background:transparent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.users-list{display:flex;flex-direction:column;gap:8px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.user{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;background:#fbfdfe;border:1px solid #eef6f4}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.dot{width:10px;height:10px;border-radius:50%}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>.small{font-size:13px;color:var(--muted)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>footer.small{margin-top:12px;color:var(--muted);font-size:13px}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>/* tiny responsive tweaks */</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>@media (max-width:480px){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>.time{font-size:36px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;/head&gt;</span></p>
<p class="p1"><span class="s1">&lt;body&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="container"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="card timer-wrap"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div style="width:100%;display:flex;justify-content:space-between;align-items:center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;strong&gt;Pomodoro Sync&lt;/strong&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div class="small"&gt;Синхронный таймер для двух людей&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="text-align:right"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div class="small"&gt;Комната: &lt;span id="roomId"&gt;default&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="circle" id="circle"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="center"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div class="time" id="timeDisplay"&gt;25:00&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div class="mode" id="modeDisplay"&gt;Work • Cycle 1&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="controls"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button class="btn" id="startPauseBtn"&gt;Start&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button class="btn secondary" id="resetBtn"&gt;Reset&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button class="btn warn" id="skipBtn"&gt;Skip&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div style="width:100%;margin-top:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="small"&gt;Последнее действие: &lt;span id="lastAction"&gt;—&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;footer class="small"&gt;Интерфейс минималистичный. Измените настройки справа, затем нажмите Start.&lt;/footer&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="field"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label&gt;Ваше имя&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;input id="username" type="text" placeholder="Введите имя..." /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="field"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label&gt;Настройки (минуты)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="display:flex;gap:8px;flex-wrap:wrap"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div&gt;&lt;label class="small"&gt;Work&lt;/label&gt;&lt;input id="workMin" type="number" min="1" value="25" /&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div&gt;&lt;label class="small"&gt;Short break&lt;/label&gt;&lt;input id="shortMin" type="number" min="1" value="5" /&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;div&gt;&lt;label class="small"&gt;Long break&lt;/label&gt;&lt;input id="longMin" type="number" min="1" value="15" /&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="field"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label&gt;Циклы до длинного перерыва&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;input id="cyclesBeforeLong" type="number" min="1" value="4" /&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="field"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label&gt;Подключенные пользователи&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="users-list" id="usersList"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div style="margin-top:8px" class="small"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;strong&gt;Инструкция по синхронизации:&lt;/strong&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div&gt;1) Создайте проект Firebase и включите Realtime Database. 2) Вставьте вашу конфигурацию Firebase внизу файла. 3) Откройте этот же URL у другого человека — вы увидите синхронизированный таймер.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div style="margin-top:12px" class="small"&gt;ПРИМЕЧАНИЕ: в этом примере используется Firebase Realtime Database (compat CDN) — вам нужно будет вставить свои ключи конфигурации ниже.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;!-- Firebase (compat) CDN - используем compat чтобы код был компактным --&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"&gt;&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"&gt;&lt;/script&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>/*******************</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">   </span>*<span class="Apple-converted-space">  </span>Основная логика</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">   </span>*******************/</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// --- Конфигурация Firebase ---</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Создайте проект в Firebase -&gt; Realtime Database -&gt; Скопируйте конфиг ниже</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Замените значения в объекте firebaseConfig на ваши.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const firebaseConfig = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>apiKey: "REPLACE_WITH_YOUR_API_KEY",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>databaseURL: "REPLACE_WITH_YOUR_DATABASE_URL",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>projectId: "REPLACE_WITH_YOUR_PROJECT_ID",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>storageBucket: "REPLACE_WITH_YOUR_STORAGE_BUCKET",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>messagingSenderId: "REPLACE_WITH_YOUR_SENDER_ID",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>appId: "REPLACE_WITH_YOUR_APP_ID"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Идентификатор комнаты — можно изменить на любой (по умолчанию "default").</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const ROOM_ID = 'default';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Инициализация Firebase</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>firebase.initializeApp(firebaseConfig);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const db = firebase.database();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Ссылки в БД</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const roomRef = db.ref('rooms/' + ROOM_ID + '/state');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const usersRef = db.ref('rooms/' + ROOM_ID + '/users');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// DOM элементы</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const timeDisplay = document.getElementById('timeDisplay');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const modeDisplay = document.getElementById('modeDisplay');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const startPauseBtn = document.getElementById('startPauseBtn');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const resetBtn = document.getElementById('resetBtn');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const skipBtn = document.getElementById('skipBtn');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const usernameInput = document.getElementById('username');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const usersList = document.getElementById('usersList');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const lastAction = document.getElementById('lastAction');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const circle = document.getElementById('circle');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const workMinInput = document.getElementById('workMin');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const shortMinInput = document.getElementById('shortMin');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const longMinInput = document.getElementById('longMin');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const cyclesBeforeLongInput = document.getElementById('cyclesBeforeLong');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>document.getElementById('roomId').textContent = ROOM_ID;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Локальное состояние клиента</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>let localUserId = 'u_' + Math.random().toString(36).slice(2,9);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>usernameInput.value = 'User-' + localUserId.slice(-3);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Значения по умолчанию (минуты)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function getSettingsFromInputs(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>work: Math.max(1, parseInt(workMinInput.value)||25),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>short: Math.max(1, parseInt(shortMinInput.value)||5),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>long: Math.max(1, parseInt(longMinInput.value)||15),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cyclesBeforeLong: Math.max(1, parseInt(cyclesBeforeLongInput.value)||4)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Если в базе нет состояния, создаём начальное состояние</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>async function ensureRoomState(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const snapshot = await roomRef.once('value');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!snapshot.exists()){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const s = getSettingsFromInputs();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// mode: 'work' | 'short' | 'long'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>roomRef.set({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mode: 'work',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cycle: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>running: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>remainingMs: s.work * 60 * 1000,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>settings: s,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lastActionBy: null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updatedAt: firebase.database.ServerValue.TIMESTAMP</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Присоединение и наличие (presence)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function joinPresence(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const meRef = usersRef.child(localUserId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const name = usernameInput.value || ('User-' + localUserId.slice(-3));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>meRef.set({name, online: true, lastSeen: firebase.database.ServerValue.TIMESTAMP});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// remove on disconnect</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>meRef.onDisconnect().remove();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// обновлять имя при изменении инпута</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>usernameInput.addEventListener('input', ()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>meRef.update({name: usernameInput.value || name, lastSeen: firebase.database.ServerValue.TIMESTAMP});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// обновлять lastSeen периодически (каждые 20 секунд)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>setInterval(()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>meRef.update({lastSeen: firebase.database.ServerValue.TIMESTAMP});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}, 20000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Отображение списка пользователей</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>usersRef.on('value', snap=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const items = snap.val()||{};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>usersList.innerHTML = '';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Object.entries(items).forEach(([id, data])=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const el = document.createElement('div');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>el.className = 'user';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const dot = document.createElement('div');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>dot.className = 'dot';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>dot.style.background = '#66bb6a';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>el.appendChild(dot);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const info = document.createElement('div');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>info.innerHTML = `&lt;div style="font-weight:600"&gt;${escapeHtml(data.name||'Anonymous')}&lt;/div&gt;&lt;div class="small"&gt;${id === localUserId ? 'You' : id}&lt;/div&gt;`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>el.appendChild(info);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>usersList.appendChild(el);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Функция экранирования простой (чтобы не ломать DOM если в имени скрипт)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function escapeHtml(s){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return String(s).replace(/[&amp;&lt;&gt;"']/g, c=&gt;({"&amp;":"&amp;amp;","&lt;":"&amp;lt;","&gt;":"&amp;gt;","\"":"&amp;quot;","'":"&amp;#39;"}[c]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Обновление состояния UI</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function renderLocalState(state){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const ms = state.remainingMs || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const mm = Math.floor(ms/60000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const ss = Math.floor((ms%60000)/1000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>timeDisplay.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>modeDisplay.textContent = `${capitalize(state.mode)} • Cycle ${state.cycle || 1}`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>startPauseBtn.textContent = state.running ? 'Pause' : 'Start';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lastAction.textContent = state.lastActionBy ? state.lastActionBy : '—';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// визуализация круга (процент)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let totalMs = getTotalMsForMode(state);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let pct = totalMs? Math.max(0, Math.min(1, (totalMs - ms) / totalMs)) : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const deg = pct * 360;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>circle.style.background = `conic-gradient(var(--accent) ${deg}deg, rgba(0,0,0,0.04) ${deg}deg)`;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function capitalize(s){return s? s[0].toUpperCase()+s.slice(1):''}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function getTotalMsForMode(state){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const s = state.settings || getSettingsFromInputs();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(state.mode === 'work') return s.work * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(state.mode === 'short') return s.short * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return s.long * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Подписка на состояние комнаты</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>let currentState = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>roomRef.on('value', snap=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const val = snap.val();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!val) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>currentState = val;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// если в базе есть settings и они отличаются от локальных инпутов — синхронизировать инпуты</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(val.settings){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>workMinInput.value = val.settings.work;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>shortMinInput.value = val.settings.short;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>longMinInput.value = val.settings.long;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cyclesBeforeLongInput.value = val.settings.cyclesBeforeLong || 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>renderLocalState(val);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Клиентский интервал для плавного отображения (таймер отсчитывается на основе remainingMs в БД)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>setInterval(()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!currentState) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(currentState.running){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// уменьшаем remainingMs локально по времени прошедшему</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// Но фактическое authoritative значение приходит из БД — это просто визуальная сглаживалка.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentState.remainingMs = Math.max(0, currentState.remainingMs - 1000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderLocalState(currentState);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}, 1000);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Кнопки: старт/пауза</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>startPauseBtn.addEventListener('click', async ()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const snap = await roomRef.once('value');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const state = snap.val();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!state) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// переключаем running</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const newRunning = !state.running;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// если запускаем — просто ставим running=true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// если ставим на паузу — сохраняем текущее remainingMs</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// для простоты: мы разрешаем клиентам перезаписывать remainingMs. В production можно добавить серверное timekeeping.</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const updates = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>running: newRunning,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastActionBy: usernameInput.value || ('User-'+localUserId.slice(-3)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updatedAt: firebase.database.ServerValue.TIMESTAMP</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// если ставим на паузу, обновим remainingMs с учетом локального ms</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!newRunning){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updates.remainingMs = currentState.remainingMs;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>await roomRef.update(updates);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Сброс</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>resetBtn.addEventListener('click', async ()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const settings = getSettingsFromInputs();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const init = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mode: 'work',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cycle: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>running: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>remainingMs: settings.work * 60 * 1000,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>settings,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastActionBy: usernameInput.value || ('User-'+localUserId.slice(-3)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updatedAt: firebase.database.ServerValue.TIMESTAMP</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>await roomRef.set(init);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Пропустить (skip) — переходим к следующему режиму</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>skipBtn.addEventListener('click', async ()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const snap = await roomRef.once('value');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const state = snap.val();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!state) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const next = nextStateAfter(state);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>next.lastActionBy = usernameInput.value || ('User-'+localUserId.slice(-3));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>next.updatedAt = firebase.database.ServerValue.TIMESTAMP;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>await roomRef.update(next);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Функция вычисления следующего состояния (после окончания режима)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function nextStateAfter(state){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const s = state.settings || getSettingsFromInputs();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let mode = state.mode || 'work';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let cycle = state.cycle || 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(mode === 'work'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// после работы: если достигнут cyclesBeforeLong -&gt; long, иначе short</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if(cycle % (s.cyclesBeforeLong || 4) === 0){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mode = 'long';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mode = 'short';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// после любого перерыва -&gt; работа, и если был long, сброс цикла к 1 иначе ++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if(mode === 'long') cycle = 1; else cycle = cycle + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mode = 'work';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const remainingMs = (mode === 'work' ? s.work : (mode === 'short' ? s.short : s.long)) * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return {mode, cycle, running: false, remainingMs, settings: s};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Опрос состояния и автоматическое переключение когда remainingMs достигает 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Подписываемся на обновления времени — используем значение updatedAt для корректности</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>roomRef.on('value', snap=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const state = snap.val();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!state) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// если таймер работает и remainingMs &lt;= 0 -&gt; переход на следующий режим</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(state.running &amp;&amp; state.remainingMs &lt;= 0){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const next = nextStateAfter(state);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>next.lastActionBy = 'system';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>next.updatedAt = firebase.database.ServerValue.TIMESTAMP;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>roomRef.update(next);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// При первом запуске — убедимся, что состояние есть</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>ensureRoomState();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>joinPresence();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Обновление настроек (когда пользователь меняет инпуты, мы пушим в БД)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>[workMinInput, shortMinInput, longMinInput, cyclesBeforeLongInput].forEach(inp=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>inp.addEventListener('change', async ()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const s = getSettingsFromInputs();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>// если таймер не запущен, просто пересчитать remainingMs</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const snap = await roomRef.once('value');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const state = snap.val() || {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const newState = {settings: s, updatedAt: firebase.database.ServerValue.TIMESTAMP};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if(!state.running){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>// пересчитать remainingMs в соответствии с mode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if(state.mode === 'work' || !state.mode) newState.remainingMs = s.work * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if(state.mode === 'short') newState.remainingMs = s.short * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else newState.remainingMs = s.long * 60 * 1000;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>await roomRef.update(newState);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Обновление lastAction видимо в UI — подписка пользователей уже выше</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Небольшая утилита: следит за изменениями remainingMs (в БД) и плавно обновляет</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Это необязательно — мы уже подписались на roomRef.on('value') выше, но оставляем для надежности.</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// Готово!</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</span></p>
<p class="p1"><span class="s1">&lt;/body&gt;</span></p>
<p class="p1"><span class="s1">&lt;/html&gt;</span></p>
<p class="p3"><span class="s1"></span><br></p>
</body>
</html>
