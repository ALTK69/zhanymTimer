<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pomodoro timer for zhanym</title>
  <style>
    /* --- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω --- */
    :root{
      --bg: #f7fafc; /* very light */
      --card: #ffffff;
      --accent: #a3d9c9; /* pastel */
      --accent-2: #f6c7c7;
      --muted: #6b7280;
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, var(--bg), #ffffff);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:20px;
      color:#111827;
    }
    .container{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:24px;
    }
    @media (max-width:880px){
      .container{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
    }

    /* Left: timer */
    .timer-wrap{display:flex;flex-direction:column;align-items:center;gap:18px;padding:36px}
    .circle{
      width:280px;height:280px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;position:relative;
      background: conic-gradient(var(--accent) 0deg, rgba(0,0,0,0.04) 0deg);
      transition: background 0.3s ease;
      box-shadow: 0 8px 30px rgba(99,102,241,0.05) inset;
    }
    @media (max-width:520px){ .circle{width:220px;height:220px}}
    .circle .center{
      width:78%;height:78%;background:var(--card);border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }
    .time{font-size:44px;font-weight:600}
    .mode{font-size:14px;color:var(--muted);margin-top:6px}

    .controls{display:flex;gap:12px}
    .btn{
      border:0;padding:10px 16px;border-radius:10px;background:var(--accent);cursor:pointer;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,0.06);
    }
    .btn.secondary{background:var(--card);border:1px solid #e6e9ef}
    .btn.warn{background:var(--accent-2)}

    /* Right column: settings + users */
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    label{font-size:13px;color:var(--muted)}
    input[type="number"], input[type="text"], select{
      padding:8px;border-radius:8px;border:1px solid #eef2f7;background:transparent
    }

    .users-list{display:flex;flex-direction:column;gap:8px}
    .user{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;background:#fbfdfe;border:1px solid #eef6f4}
    .dot{width:10px;height:10px;border-radius:50%}
    .small{font-size:13px;color:var(--muted)}

    footer.small{margin-top:12px;color:var(--muted);font-size:13px}

    /* tiny responsive tweaks */
    @media (max-width:480px){
      .time{font-size:36px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card timer-wrap">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Pomodoro Timer</strong>
          <div class="small">–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –¥–≤—É—Ö –ª—é–¥–µ–π</div>
        </div>
        <div style="text-align:right">
          <div class="small">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomId">love</span></div> 
        </div>
      </div>

      <div class="circle" id="circle">
        <div class="center">
          <div class="time" id="timeDisplay">25:00</div>
          <div class="mode" id="modeDisplay">Study ‚Ä¢ Cycle 1</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="startPauseBtn">Start</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
        <button class="btn warn" id="skipBtn">Skip</button>
      </div>

      <div style="width:100%;margin-top:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <div class="small">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ: <span id="lastAction">‚Äî</span></div>
      </div>

      <footer class="small">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π. –ü–æ–º–µ–Ω—è–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø—Ä–∞–≤–∞ –∫–∞–∫ —Ç–µ–±–µ —É–¥–æ–±–Ω–æ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ Start –ñ–∞–Ω—ã–º :3</footer>
    </div>

    <div class="card">
      <div class="field">
        <label>–ù–∏–∫–Ω–µ–π–º</label>
        <input id="username" type="text" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫ –ñ–∞–Ω..." />
      </div>

      <div class="field">
        <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–∏–Ω—É—Ç—ã)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div><label class="small">Work</label><input id="workMin" type="number" min="1" value="25" /></div>
          <div><label class="small">Short break</label><input id="shortMin" type="number" min="1" value="5" /></div>
          <div><label class="small">Long break</label><input id="longMin" type="number" min="1" value="15" /></div>
        </div>
      </div>

      <div class="field">
        <label>–¶–∏–∫–ª—ã –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞</label>
        <input id="cyclesBeforeLong" type="number" min="1" value="4" />
      </div>

      <div class="field">
        <label>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–º–æ–∏ —Ç–≤–∏–Ω–∫–∏ :3)</label>
        <div class="users-list" id="usersList"></div>
      </div>

      <div style="margin-top:8px" class="small">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–¥–µ—Ü:</strong>
        <div> –æ—á–∏—Å—Ç–∏—Ç–µ —Ä–∞–∑—É–º, –ø–æ–π–º–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π —Ñ–æ–∫—É—Å –∏ –ø–æ–¥—É–º–∞–π –æ —Å–≤–µ–æ–º –ø–∞—Ä—Ç–Ω–µ—Ä–µ ( –ñ–∞–Ω—ã–º :3 ) –≤–æ–∑—å–º–∏ –≤—Å–µ —Å–≤–æ–∏ —á—É—Å—Ç–≤–∞ –≤ —Ä—É–∫–∏ –∏ –ø–æ–ø—ã—Ç–∞–π—Å—è –∏—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ —Ç—ã—Å—è—á–∏ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤ —á—Ç–æ –º–µ–∂–¥—É –Ω–∞–º–∏—é /</div>
      </div>

      <div style="margin-top:12px" class="small">–ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –ù–∞—à–∏ —Å–µ—Ä–¥—Ü–∞ —É–∂–µ –∏ —Ç–∞–∫ —Å–æ–µ–¥–µ–Ω—ã–π –∏ –º—ã –±—É–∫–≤–∞–ª—å–Ω–æ —Å–ª–∏–≤–∞–µ–º—Å—è –≤ –æ–¥–Ω—É –¥—É—à—É üíö</div>
    </div>
  </div>

  <!-- Firebase (compat) CDN - –∏—Å–ø–æ–ª—å–∑—É–µ–º compat —á—Ç–æ–±—ã –∫–æ–¥ –±—ã–ª –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
  /*******************
   *  –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
   *******************/

  // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ---
  // –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Firebase -> Realtime Database -> –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –Ω–∏–∂–µ
  // –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ–±—ä–µ–∫—Ç–µ firebaseConfig –Ω–∞ –≤–∞—à–∏.
const firebaseConfig = {
  apiKey: "AIzaSyA1M0QuJABvZdOLAEbA28jhnJuRkHNkrYo",
  authDomain: "zhanym-6d7e8.firebaseapp.com",
  databaseURL: "https://zhanym-6d7e8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "zhanym-6d7e8",
  storageBucket: "zhanym-6d7e8.firebasestorage.app",
  messagingSenderId: "115835636741",
  appId: "1:115835636741:web:a800faa31340052702606c",
  measurementId: "G-DDZK46WJ3Z"
};


  // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–º–Ω–∞—Ç—ã ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –ª—é–±–æ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "default").
  const ROOM_ID = 'default';

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // –°—Å—ã–ª–∫–∏ –≤ –ë–î
  const roomRef = db.ref('rooms/' + ROOM_ID + '/state');
  const usersRef = db.ref('rooms/' + ROOM_ID + '/users');

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const timeDisplay = document.getElementById('timeDisplay');
  const modeDisplay = document.getElementById('modeDisplay');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const skipBtn = document.getElementById('skipBtn');
  const usernameInput = document.getElementById('username');
  const usersList = document.getElementById('usersList');
  const lastAction = document.getElementById('lastAction');
  const circle = document.getElementById('circle');

  const workMinInput = document.getElementById('workMin');
  const shortMinInput = document.getElementById('shortMin');
  const longMinInput = document.getElementById('longMin');
  const cyclesBeforeLongInput = document.getElementById('cyclesBeforeLong');

  document.getElementById('roomId').textContent = ROOM_ID;

  // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  let localUserId = 'u_' + Math.random().toString(36).slice(2,9);
  usernameInput.value = 'User-' + localUserId.slice(-3);

  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–∏–Ω—É—Ç—ã)
  function getSettingsFromInputs(){
    return {
      work: Math.max(1, parseInt(workMinInput.value)||25),
      short: Math.max(1, parseInt(shortMinInput.value)||5),
      long: Math.max(1, parseInt(longMinInput.value)||15),
      cyclesBeforeLong: Math.max(1, parseInt(cyclesBeforeLongInput.value)||4)
    };
  }

  // –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Å–æ–∑–¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  async function ensureRoomState(){
    const snapshot = await roomRef.once('value');
    if(!snapshot.exists()){
      const s = getSettingsFromInputs();
      // mode: 'work' | 'short' | 'long'
      roomRef.set({
        mode: 'work',
        cycle: 1,
        running: false,
        remainingMs: s.work * 60 * 1000,
        settings: s,
        lastActionBy: null,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
  }

  // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –Ω–∞–ª–∏—á–∏–µ (presence)
  function joinPresence(){
    const meRef = usersRef.child(localUserId);
    const name = usernameInput.value || ('User-' + localUserId.slice(-3));
    meRef.set({name, online: true, lastSeen: firebase.database.ServerValue.TIMESTAMP});
    // remove on disconnect
    meRef.onDisconnect().remove();

    // –æ–±–Ω–æ–≤–ª—è—Ç—å –∏–º—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–ø—É—Ç–∞
    usernameInput.addEventListener('input', ()=>{
      meRef.update({name: usernameInput.value || name, lastSeen: firebase.database.ServerValue.TIMESTAMP});
    });

    // –æ–±–Ω–æ–≤–ª—è—Ç—å lastSeen –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥)
    setInterval(()=>{
      meRef.update({lastSeen: firebase.database.ServerValue.TIMESTAMP});
    }, 20000);
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  usersRef.on('value', snap=>{
    const items = snap.val()||{};
    usersList.innerHTML = '';
    Object.entries(items).forEach(([id, data])=>{
      const el = document.createElement('div');
      el.className = 'user';
      const dot = document.createElement('div');
      dot.className = 'dot';
      dot.style.background = '#66bb6a';
      el.appendChild(dot);
      const info = document.createElement('div');
      info.innerHTML = `<div style="font-weight:600">${escapeHtml(data.name||'Anonymous')}</div><div class="small">${id === localUserId ? 'You' : id}</div>`;
      el.appendChild(info);
      usersList.appendChild(el);
    });
  });

  // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–π (—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å DOM –µ—Å–ª–∏ –≤ –∏–º–µ–Ω–∏ —Å–∫—Ä–∏–ø—Ç)
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
  function renderLocalState(state){
    const ms = state.remainingMs || 0;
    const mm = Math.floor(ms/60000);
    const ss = Math.floor((ms%60000)/1000);
    timeDisplay.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    modeDisplay.textContent = `${capitalize(state.mode)} ‚Ä¢ Cycle ${state.cycle || 1}`;

    startPauseBtn.textContent = state.running ? 'Pause' : 'Start';
    lastAction.textContent = state.lastActionBy ? state.lastActionBy : '‚Äî';

    // –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫—Ä—É–≥–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç)
    let totalMs = getTotalMsForMode(state);
    let pct = totalMs? Math.max(0, Math.min(1, (totalMs - ms) / totalMs)) : 0;
    const deg = pct * 360;
    circle.style.background = `conic-gradient(var(--accent) ${deg}deg, rgba(0,0,0,0.04) ${deg}deg)`;
  }

  function capitalize(s){return s? s[0].toUpperCase()+s.slice(1):''}

  function getTotalMsForMode(state){
    const s = state.settings || getSettingsFromInputs();
    if(state.mode === 'work') return s.work * 60 * 1000;
    if(state.mode === 'short') return s.short * 60 * 1000;
    return s.long * 60 * 1000;
  }

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
  let currentState = null;
  roomRef.on('value', snap=>{
    const val = snap.val();
    if(!val) return;
    currentState = val;

    // –µ—Å–ª–∏ –≤ –±–∞–∑–µ –µ—Å—Ç—å settings –∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–ø—É—Ç–æ–≤ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–ø—É—Ç—ã
    if(val.settings){
      workMinInput.value = val.settings.work;
      shortMinInput.value = val.settings.short;
      longMinInput.value = val.settings.long;
      cyclesBeforeLongInput.value = val.settings.cyclesBeforeLong || 4;
    }

    renderLocalState(val);
  });

  // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–∞–π–º–µ—Ä –æ—Ç—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ remainingMs –≤ –ë–î)
  setInterval(()=>{
    if(!currentState) return;
    if(currentState.running){
      // —É–º–µ–Ω—å—à–∞–µ–º remainingMs –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–µ–¥—à–µ–º—É
      // –ù–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ authoritative –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –ë–î ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Å–≥–ª–∞–∂–∏–≤–∞–ª–∫–∞.
      currentState.remainingMs = Math.max(0, currentState.remainingMs - 1000);
      renderLocalState(currentState);
    }
  }, 1000);

  // –ö–Ω–æ–ø–∫–∏: —Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞
  startPauseBtn.addEventListener('click', async ()=>{
    const snap = await roomRef.once('value');
    const state = snap.val();
    if(!state) return;

    // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º running
    const newRunning = !state.running;
    // –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º running=true
    // –µ—Å–ª–∏ —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ remainingMs
    // –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –º—ã —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å remainingMs. –í production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ timekeeping.

    const updates = {
      running: newRunning,
      lastActionBy: usernameInput.value || ('User-'+localUserId.slice(-3)),
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };

    // –µ—Å–ª–∏ —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É, –æ–±–Ω–æ–≤–∏–º remainingMs —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ ms
    if(!newRunning){
      updates.remainingMs = currentState.remainingMs;
    }

    await roomRef.update(updates);
  });

  // –°–±—Ä–æ—Å
  resetBtn.addEventListener('click', async ()=>{
    const settings = getSettingsFromInputs();
    const init = {
      mode: 'work',
      cycle: 1,
      running: false,
      remainingMs: settings.work * 60 * 1000,
      settings,
      lastActionBy: usernameInput.value || ('User-'+localUserId.slice(-3)),
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    await roomRef.set(init);
  });

  // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (skip) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–µ–∂–∏–º—É
  skipBtn.addEventListener('click', async ()=>{
    const snap = await roomRef.once('value');
    const state = snap.val();
    if(!state) return;
    const next = nextStateAfter(state);
    next.lastActionBy = usernameInput.value || ('User-'+localUserId.slice(-3));
    next.updatedAt = firebase.database.ServerValue.TIMESTAMP;
    await roomRef.update(next);
  });

  // –§—É–Ω–∫—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞)
  function nextStateAfter(state){
    const s = state.settings || getSettingsFromInputs();
    let mode = state.mode || 'work';
    let cycle = state.cycle || 1;
    if(mode === 'work'){
      // –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã: –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç cyclesBeforeLong -> long, –∏–Ω–∞—á–µ short
      if(cycle % (s.cyclesBeforeLong || 4) === 0){
        mode = 'long';
      } else {
        mode = 'short';
      }
    } else {
      // –ø–æ—Å–ª–µ –ª—é–±–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ -> —Ä–∞–±–æ—Ç–∞, –∏ –µ—Å–ª–∏ –±—ã–ª long, —Å–±—Ä–æ—Å —Ü–∏–∫–ª–∞ –∫ 1 –∏–Ω–∞—á–µ ++
      if(mode === 'long') cycle = 1; else cycle = cycle + 1;
      mode = 'work';
    }

    const remainingMs = (mode === 'work' ? s.work : (mode === 'short' ? s.short : s.long)) * 60 * 1000;
    return {mode, cycle, running: false, remainingMs, settings: s};
  }

  // –û–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–≥–¥–∞ remainingMs –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 0
  // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ updatedAt –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
  roomRef.on('value', snap=>{
    const state = snap.val();
    if(!state) return;
    // –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ remainingMs <= 0 -> –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–∂–∏–º
    if(state.running && state.remainingMs <= 0){
      const next = nextStateAfter(state);
      next.lastActionBy = 'system';
      next.updatedAt = firebase.database.ServerValue.TIMESTAMP;
      roomRef.update(next);
    }
  });

  // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ ‚Äî —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å—Ç—å
  ensureRoomState();
  joinPresence();

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –∏–Ω–ø—É—Ç—ã, –º—ã –ø—É—à–∏–º –≤ –ë–î)
  [workMinInput, shortMinInput, longMinInput, cyclesBeforeLongInput].forEach(inp=>{
    inp.addEventListener('change', async ()=>{
      const s = getSettingsFromInputs();
      // –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å remainingMs
      const snap = await roomRef.once('value');
      const state = snap.val() || {};
      const newState = {settings: s, updatedAt: firebase.database.ServerValue.TIMESTAMP};
      if(!state.running){
        // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å remainingMs –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å mode
        if(state.mode === 'work' || !state.mode) newState.remainingMs = s.work * 60 * 1000;
        else if(state.mode === 'short') newState.remainingMs = s.short * 60 * 1000;
        else newState.remainingMs = s.long * 60 * 1000;
      }
      await roomRef.update(newState);
    });
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ lastAction –≤–∏–¥–∏–º–æ –≤ UI ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∂–µ –≤—ã—à–µ

  // –ù–µ–±–æ–ª—å—à–∞—è —É—Ç–∏–ª–∏—Ç–∞: —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ remainingMs (–≤ –ë–î) –∏ –ø–ª–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç
  // –≠—Ç–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî –º—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ roomRef.on('value') –≤—ã—à–µ, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

  // –ì–æ—Ç–æ–≤–æ!
  </script>
</body>
</html>

